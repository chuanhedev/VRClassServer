<!DOCTYPE html>
<html>
<!-- <style>
    #drop-area {
        border: 2px dashed #ccc;
        border-radius: 20px;
        width: 480px;
        font-family: sans-serif;
        margin: 100px auto;
        padding: 20px;
    }

    #drop-area.highlight {
        border-color: purple;
    }

    p {
        margin-top: 0;
    }

    .my-form {
        margin-bottom: 10px;
    }

    #gallery {
        margin-top: 10px;
    }

    #gallery img {
        width: 150px;
        margin-bottom: 10px;
        margin-right: 10px;
        vertical-align: middle;
    }

    .button {
        display: inline-block;
        padding: 10px;
        background: #ccc;
        cursor: pointer;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .button:hover {
        background: #ddd;
    }

    #fileElem {
        display: none;
    }
</style> -->

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/main.min.css">
    <script src="../lib/md5.min.js"></script>
</head>

<body>
    <header class="navbar">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home"
                    aria-selected="true">版本</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="event-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile"
                    aria-selected="false">事件</a>
            </li>
        </ul>
    </header>
    <div class="container">
        <div class="tab-content mt-3" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <p class="h3" id="currentVersion"></p>
                <p>服务器文件</p>
                <table class="table table-sm table-striped" id="filesServer">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">文件名</th>
                            <th scope="col">大小</th>
                            <th scope="col">MD5</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <hr />
                <div>
                    发布版本号: <input value="" id="publishVersion">
                </div>
                <div id="drop-area" class=" m-3 p-3">
                    <form class="my-form">
                        <p>把上传的文件拖进这里</p>
                        <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)">
                        <!-- <label class="button" for="fileElem">Select some files</label> -->
                    </form>
                    <!-- <progress id="progress-bar" max=100 value=0></progress> -->
                    <!-- <div id="gallery" /> -->
                </div>
                <p>上传文件</p>
                <table class="table table-sm table-striped" id="filesUploaded">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">文件名</th>
                            <th scope="col">大小</th>
                            <th scope="col">MD5</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <input class="btn btn-primary" value="上传" onclick="onUploadFiles()">
            </div>
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="event-tab">
                <div class="row">
                    <div class="ml-3 mr-3">
                        <label>事件间隔</label>
                        <select class='dropdown' onchange="renderGraph()" id="ddEventTimeGap">
                            <option class="dropdown-item" value='1h'>1小时</option>
                            <option class="dropdown-item" value='1d' selected="selected">1天</option>
                        </select>
                    </div>
                    <div class="ml-3 mr-3">
                        <label>间隔数量</label>
                        <select class='dropdown' onchange="renderGraph()" id="ddEventTotalGap">
                            <option class="dropdown-item" value='20' selected="selected">20</option>
                            <option class="dropdown-item" value='50'>50</option>
                            <option class="dropdown-item" value='100'>100</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="ml-3 mr-3">
                        <label>事件名</label>
                        <select class='dropdown' onchange="renderGraph()" id="ddEventName">
                        </select>
                    </div>
                </div>

                <!-- Default unchecked -->
                <div class="m-3">
                    <span class="custom-radio col-md-3">
                        <input type="radio" class="custom-control-input" id="graphStyleLine" name="graphStyleBar"
                            onclick="renderGraph();" checked>
                        <label class="custom-control-label" for="graphStyleLine">线形</label>
                    </span>

                    <!-- Default checked -->
                    <span class="custom-radio col-md-3">
                        <input type="radio" class="custom-control-input" id="graphStyleBar" name="graphStyleBar"
                            onclick="renderGraph();">
                        <label class="custom-control-label" for="graphStyleBar">柱形</label>
                    </span>
                </div>
                <div id="myChartContainer">

                </div>
            </div>
        </div>
    </div>

</body>
<script src="../lib/jquery.min.js"></script>
<script src="../lib/popper.min.js"></script>
<script src="../lib/chart.min.js"></script>
<script src="../lib/bootstrap.min.js"></script>
<script>
    // ************************ Drag and drop ***************** //
    let dropArea = document.getElementById("drop-area")

    // Prevent default drag behaviors
    ;
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false)
        document.body.addEventListener(eventName, preventDefaults, false)
    })

    // Highlight drop area when item is dragged over it
    ;
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false)
    })

    ;
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false)
    })

    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false)

    function preventDefaults(e) {
        e.preventDefault()
        e.stopPropagation()
    }

    function highlight(e) {
        dropArea.classList.add('highlight')
    }

    function unhighlight(e) {
        dropArea.classList.remove('active')
    }

    function handleDrop(e) {
        var dt = e.dataTransfer
        var files = dt.files

        handleFiles(files)
    }

    let uploadProgress = []
    let progressBar = document.getElementById('progress-bar')

    function initializeProgress(numFiles) {
        progressBar.value = 0
        uploadProgress = []

        for (let i = numFiles; i > 0; i--) {
            uploadProgress.push(0)
        }
    }

    function updateProgress(fileNumber, percent) {
        uploadProgress[fileNumber] = percent
        let total = uploadProgress.reduce((tot, curr) => tot + curr, 0) / uploadProgress.length
        console.debug('update', fileNumber, percent, total)
        progressBar.value = total
    }

    function handleFiles(files) {
        files = [...files]
        // initializeProgress(files.length)
        renderTable(files);
        // files.forEach(uploadFile)
        // files.forEach(previewFile)
    }

    function previewFile(file) {
        let reader = new FileReader()
        reader.readAsDataURL(file)
        reader.onloadend = function () {
            let img = document.createElement('img')
            img.src = reader.result
            document.getElementById('gallery').appendChild(img)
        }
    }

    function renderTable(files) {
        console.log(files);
        let tableContent = document.querySelector("#filesUploaded tbody");
        tableContent.innerHTML = "";
        let rowIndex = 1;
        for (let i = 0; i < files.length; i++) {
            let file = files[i];
            let key = "|" + file.name;
            // console.log(typeof(file));
            // console.log(md5.file(files[i]));
            uploadFiles[key] = {
                file: file
            };
            let reader = new FileReader();
            reader.onload = function () {
                var arrayBuffer = this.result,
                    array = new Uint8Array(arrayBuffer);
                // binaryString = String.fromCharCode.apply(null, array);
                let file_md5 = md5(array);
                if (serverFiles[key] && serverFiles[key].md5 == file_md5)
                    delete uploadFiles[key]
                else
                    uploadFiles[key].md5 = file_md5;
                let row = document.createElement("tr");
                row.innerHTML =
                    `<th>${rowIndex++}</th><td>${file.name}</td><td>${(file.size/1000).toFixed(2)}kb</td><td>${file_md5}</td>`;
                tableContent.appendChild(row);
            }
            reader.readAsArrayBuffer(files[i]);
        }
    }


    // #	文件名	大小	MD5
    // 0	2.jpg	48517.08kb	d0fc35af50238da5ef20b5b511328a60
    // 1	3.jpg	47221.85kb	f523c41e133f83f5d3d082deb94bccad
    // 2	1.jpg	49291.56kb	ee224e07441a6b6f27d951d9bbfb2745

    function uploadFile(file, i) {
        var url = './upload.php'
        var xhr = new XMLHttpRequest()
        var formData = new FormData()
        xhr.open('POST', url, true)
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

        // Update progress (can be used to show progress indicator)
        xhr.upload.addEventListener("progress", function (e) {
            updateProgress(i, (e.loaded * 100.0 / e.total) || 100)
        })

        xhr.addEventListener('readystatechange', function (e) {
            if (xhr.readyState == 4 && xhr.status == 200) {
                updateProgress(i, 100); // <- Add this
                console.log(xhr);
                console.log(this.responseText);
            } else if (xhr.readyState == 4 && xhr.status != 200) {
                // Error. Inform the user
            }
        })
        formData.append('fileToUpload', file)
        xhr.send(formData)
    }

    function onUploadFiles() {
        let version = document.getElementById("publishVersion").value;
        if (!version) {
            console.log('version is empty');
            return;
        }
        if (Object.keys(uploadFiles).length == 0) {
            console.log('nothing to upload');
            return;
        }
        console.log(uploadFiles);
        let upload_status = {};
        for (let key in uploadFiles) {
            let file = uploadFiles[key].file;
            console.log(file);
            var formData = new FormData();
            formData.append('fileToUpload', file)
            $.ajax({
                type: "POST",
                url: "./upload.php",
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    if (data == "1") {
                        upload_status[key] = true;
                        //check if all uploaded
                        for (let key in uploadFiles) {
                            if (!upload_status[key]) {
                                return;
                            }
                        }
                        onUploadFilesDone();
                    }
                },
                data: formData
            })
        }
    }

    function onUploadFilesDone() {
        let data = {
            version: document.getElementById("publishVersion").value,
            files: []
        };
        for (let key in uploadFiles) {
            let file = uploadFiles[key].file;
            data.files.push({
                name: file.name,
                size: (file.size / 1000).toFixed(2),
                md5: uploadFiles[key].md5,
            });
        }
        console.log(data);
        $.ajax({
            type: "POST",
            url: "./upload_done.php",
            success: function (data) {
                console.log(data);
            },
            data: {
                data: JSON.stringify(data)
            }
        })
    }

    // function graphStyleRadioClick(e) {
    //     console.log('clicked', e);
    // }
    function renderGraph() {
        let timeGap = document.getElementById("ddEventTimeGap").value;
        let gapCount = document.getElementById("ddEventTotalGap").value;
        let gap;
        if (timeGap == '1h')
            gap = 3600;
        else if (timeGap == '1d')
            gap = 24 * 3600;
        $.ajax({
            type: "POST",
            url: "./event.php",
            success: function (data) {
                console.log('render ', data);
                renderGraph2(JSON.parse(data).data);
            },
            data: {
                data: JSON.stringify({
                    gap: gap,
                    gapCount: gapCount
                })
            }
        })
    }

    function getTimeGap(str) {
        let gap;
        if (str == '1h')
            gap = 3600;
        else if (str == '1d')
            gap = 24 * 3600;
        return gap;
    }

    function renderGraph2(data) {
        let timeGap = document.getElementById("ddEventTimeGap").value;
        let totalGap = parseInt(document.getElementById("ddEventTotalGap").value);
        let graphStyleLine = document.getElementById("graphStyleLine").checked;
        let graphStyleBar = document.getElementById("graphStyleBar").checked;
        let type = graphStyleLine ? 'line' : 'bar';
        let stacked = graphStyleLine ? false : true;
        var chartContainer = document.getElementById("myChartContainer");
        chartContainer.innerHTML = "&nbsp;";
        chartContainer.innerHTML = `<canvas id="myChart" width="400" height="200"></canvas>`;
        var ctx = document.getElementById("myChart").getContext('2d');
        let now = new Date();
        now.setMilliseconds(0);
        now.setSeconds(0);
        now.setMinutes(0);
        let xLabels = [];
        if (timeGap.substr(-1) == 'd') {
            now.setHours(0);
        }
        let gap = getTimeGap(timeGap) * 1000;
        let numLabels = 10;
        let dataByName = {};
        let dataByTime = {};
        for (let i = 0; i < data.length; i++) {
            let d = data[i];
            if (!dataByName[d.name])
                dataByName[d.name] = {
                    data: []
                };
            if (!dataByTime[d.timekey])
                dataByTime[d.timekey] = {};
            dataByName[d.name][d.timekey] = d.count;
            dataByTime[d.timekey][d.name] = d.count;
        }
        for (let i = 0; i < totalGap; i++) {
            let t = new Date(now.getTime() - i * gap);
            let timeKey = (t.getTime() / 1000).toString();
            if (i % (Math.round(totalGap / numLabels)) == 0) {
                let tStr = (t.getMonth() + 1) + '-' + t.getDate();
                if (timeGap.substr(-1) == 'h')
                    tStr += ' ' + t.getHours() + 'h';
                xLabels.unshift(tStr);
            } else {
                xLabels.unshift("");
            }
            for (let k in dataByName) {
                if (dataByTime[timeKey] && dataByTime[timeKey][k])
                    dataByName[k].data.unshift(dataByTime[timeKey][k]);
                else
                    dataByName[k].data.unshift(0);
            }
        }
        let datasets = [];
        let idx = 0;
        for (let k in dataByName) {
            datasets.push({
                data: dataByName[k].data,
                fill: false,
                label: k,
                backgroundColor: Chart.helpers.color(getChartColor(idx)).alpha(0.5).rgbString(),
                borderColor: getChartColor(idx)
            });
            idx++;
        }

        //dropdown 
        let ddEventName = document.getElementById("ddEventName");
        ddEventName.innerHTML = `<option class="dropdown-item" value=''></option>`;
        for (let k in dataByName) {
            ddEventName.innerHTML += `<option class="dropdown-item" value='${k}'>${k}</option>`;
        }

        var myChart = new Chart(ctx, {
            type: type,
            data: {
                datasets: datasets,
                // datasets: [{
                //     data: [0, 45, 25, 20, 10, 2],
                //     fill: false,
                //     label: "data1",
                //     backgroundColor: Chart.helpers.color(getChartColor()).alpha(0.5).rgbString(),
                //     borderColor: getChartColor()
                // }, {
                //     data: [20, 35, 15, 40, 15, -5],
                //     fill: false,
                //     label: "data2",
                //     backgroundColor: Chart.helpers.color(getChartColor(1)).alpha(0.5).rgbString(),
                //     borderColor: getChartColor(1)
                // }],
                labels: xLabels
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        },
                        stacked: stacked
                    }],
                    xAxes: [{
                        stacked: stacked
                    }]
                },
                elements: {
                    line: {
                        tension: 0, // disables bezier curves
                    }
                },
                animation: {
                    duration: 0, // general animation time
                },
                hover: {
                    animationDuration: 0, // duration of animations when hovering an item
                },
                responsiveAnimationDuration: 0, // animation duration after a resize
            }
        });
    }



    let serverFiles = {};
    let uploadFiles = {};

    function getChartColor(idx = 0) {
        // console.log(window.chartColors);
        var colorNames = Object.keys(window.chartColors);
        var colorName = colorNames[idx % colorNames.length];
        var dsColor = window.chartColors[colorName];
        // console.log(colorNames, colorName, dsColor);
        return dsColor;
    }

    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'
    };

    $(function () {
        $.ajax({
            url: "../version.php",
            success: function (data) {
                console.log(data);
                document.getElementById("currentVersion").innerText = "当前版本号：" + data.version;
                let table = document.querySelector("#filesServer tbody");
                console.log(table);
                let rowIndex = 0;
                for (let i = 0; i < data.files.length; i++) {
                    let file = data.files[i];
                    let row = document.createElement("tr");
                    row.innerHTML =
                        `<th>${rowIndex++}</th><td>${file.name}</td><td>${file.size}</td><td>${file.md5}</td>`;
                    table.appendChild(row);
                    serverFiles[file.path + "|" + file.name] = file;
                }
            },
            dataType: "json"
        });
        renderGraph();
    })
</script>

</html>